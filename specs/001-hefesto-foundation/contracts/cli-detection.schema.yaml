# CLI Detection Contract Schema
# Defines the interface for CLI detection operations in Hefesto Foundation

---
openapi: 3.0.0
info:
  title: Hefesto CLI Detection API
  version: 1.0.0
  description: |
    Contract defining CLI detection operations for the Hefesto Foundation Infrastructure.
    This is a logical API (not HTTP-based) representing the interface between detection
    logic and the bootstrap process.

components:
  schemas:
    DetectionMethod:
      type: string
      enum:
        - PATH
        - config_directory
        - manual
      description: Method used to detect the CLI

    CLIStatus:
      type: string
      enum:
        - active
        - warning_no_path
        - error_permission
      description: Current status of the detected CLI

    CLIName:
      type: string
      enum:
        - claude
        - gemini
        - codex
        - copilot
        - opencode
        - cursor
        - qwen
      description: Canonical CLI identifier

    CLIDetectionResult:
      type: object
      required:
        - name
        - detection_method
        - skills_directory_path
        - status
      properties:
        name:
          $ref: '#/components/schemas/CLIName'
        detection_method:
          $ref: '#/components/schemas/DetectionMethod'
        version:
          type: string
          nullable: true
          pattern: '^\d+\.\d+\.\d+$'
          description: Detected CLI version (SemVer format) or null if unavailable
        skills_directory_path:
          type: string
          pattern: '^\.[a-z]+/skills/?$'
          description: Relative path to skills directory for this CLI
        status:
          $ref: '#/components/schemas/CLIStatus'
      example:
        name: claude
        detection_method: PATH
        version: "1.2.0"
        skills_directory_path: .claude/skills/
        status: active

    DetectionRequest:
      type: object
      properties:
        force_redetect:
          type: boolean
          default: false
          description: Force re-detection even if cached results exist
        manual_clis:
          type: array
          items:
            $ref: '#/components/schemas/CLIName'
          description: Manually specified CLIs to add (used when no auto-detection succeeds)
      example:
        force_redetect: false
        manual_clis: []

    DetectionResponse:
      type: object
      required:
        - detected_clis
        - total_detected
        - warnings
        - errors
      properties:
        detected_clis:
          type: array
          items:
            $ref: '#/components/schemas/CLIDetectionResult'
          description: List of all detected CLIs
        total_detected:
          type: integer
          minimum: 0
          description: Total number of CLIs detected
        warnings:
          type: array
          items:
            $ref: '#/components/schemas/DetectionWarning'
          description: Non-fatal warnings encountered during detection
        errors:
          type: array
          items:
            $ref: '#/components/schemas/DetectionError'
          description: Errors encountered during detection
      example:
        detected_clis:
          - name: claude
            detection_method: PATH
            version: "1.2.0"
            skills_directory_path: .claude/skills/
            status: active
          - name: gemini
            detection_method: config_directory
            version: null
            skills_directory_path: .gemini/skills/
            status: warning_no_path
        total_detected: 2
        warnings:
          - cli_name: gemini
            message: "CLI detected via config directory but not found in PATH"
            severity: low
        errors: []

    DetectionWarning:
      type: object
      required:
        - cli_name
        - message
        - severity
      properties:
        cli_name:
          $ref: '#/components/schemas/CLIName'
        message:
          type: string
          description: Human-readable warning message
        severity:
          type: string
          enum:
            - low
            - medium
          description: Warning severity level
      example:
        cli_name: gemini
        message: "CLI detected via config directory but not found in PATH"
        severity: low

    DetectionError:
      type: object
      required:
        - cli_name
        - error_type
        - message
      properties:
        cli_name:
          $ref: '#/components/schemas/CLIName'
        error_type:
          type: string
          enum:
            - permission_denied
            - disk_full
            - path_not_writable
          description: Error category
        message:
          type: string
          description: Human-readable error message
        resolution:
          type: string
          description: Suggested resolution steps
      example:
        cli_name: copilot
        error_type: permission_denied
        message: "Permission denied creating .github/skills/"
        resolution: "Run with appropriate permissions or manually create directory"

    DirectoryCreationRequest:
      type: object
      required:
        - cli_name
        - target_path
      properties:
        cli_name:
          $ref: '#/components/schemas/CLIName'
        target_path:
          type: string
          description: Directory path to create
        permissions:
          type: string
          default: "rwx------"
          description: Unix-style permissions (for Unix/macOS)
      example:
        cli_name: claude
        target_path: .claude/skills/
        permissions: "rwx------"

    DirectoryCreationResponse:
      type: object
      required:
        - success
        - path
      properties:
        success:
          type: boolean
          description: Whether directory creation succeeded
        path:
          type: string
          description: Absolute path to created directory
        error:
          type: string
          nullable: true
          description: Error message if creation failed
      example:
        success: true
        path: /home/user/projects/my-app/.claude/skills/
        error: null

paths:
  /detect:
    post:
      summary: Detect installed AI CLIs
      description: |
        Scans the system for installed AI CLIs using multiple detection strategies:
        1. PATH environment variable scanning
        2. Standard config directory checks
        3. Manual specification (fallback)
      operationId: detectCLIs
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DetectionRequest'
      responses:
        '200':
          description: Detection completed (may include warnings/errors for individual CLIs)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DetectionResponse'

  /create-directory:
    post:
      summary: Create skill directory for detected CLI
      description: |
        Creates the skills directory structure for a detected CLI with appropriate
        permissions. Idempotent - returns success if directory already exists.
      operationId: createSkillDirectory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DirectoryCreationRequest'
      responses:
        '200':
          description: Directory creation result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DirectoryCreationResponse'

  /validate-cli:
    post:
      summary: Validate a specific CLI is accessible
      description: |
        Verifies that a CLI can be executed and its version can be retrieved.
        Used to distinguish between active vs. config-only installations.
      operationId: validateCLI
      parameters:
        - name: cli_name
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/CLIName'
      responses:
        '200':
          description: Validation result
          content:
            application/json:
              schema:
                type: object
                properties:
                  is_accessible:
                    type: boolean
                    description: Whether CLI can be executed via PATH
                  version:
                    type: string
                    nullable: true
                    description: Detected version if accessible

# Behavioral Contracts (Non-HTTP)

# Contract 1: Detection Priority
# GIVEN multiple detection methods available
# WHEN detecting a CLI
# THEN PATH detection takes precedence over config directory detection

# Contract 2: Parallel Detection
# GIVEN 7 CLIs to detect
# WHEN detection is triggered
# THEN all CLIs MUST be checked in parallel (not sequentially)
# AND total detection time MUST be < 2 seconds

# Contract 3: Idempotent Directory Creation
# GIVEN a skills directory already exists for a CLI
# WHEN directory creation is requested
# THEN operation MUST succeed without error
# AND existing directory MUST NOT be modified
# AND return path to existing directory

# Contract 4: Graceful Degradation
# GIVEN permission error creating directory for one CLI
# WHEN bootstrapping multiple CLIs
# THEN other CLIs MUST continue to be processed
# AND error MUST be reported in response.errors[]
# AND successful CLIs MUST be listed in response.detected_clis[]

# Contract 5: Cross-Platform Consistency
# GIVEN the same CLIs installed on Windows, macOS, and Linux
# WHEN detection runs on each platform
# THEN the same CLIs MUST be detected
# AND skills_directory_path format MUST be consistent (relative paths)

# Contract 6: Version Detection Failure Tolerance
# GIVEN a CLI is in PATH but version cannot be determined
# WHEN detection runs
# THEN CLI MUST still be detected
# AND version MUST be set to null
# AND status MUST be "active" (not an error condition)
